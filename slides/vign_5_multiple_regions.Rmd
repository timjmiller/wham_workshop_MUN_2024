---
title:  "Configuring multiple stocks and regions and movement"
subtitle: ""
author: "Tim Miller<br>NOAA Fisheries, NEFSC"
output:
  xaringan::moon_reader:
    self_contained: true
    css: ["xaringan-themer_16_9.css", "slides-style_TMB201.css"]
    lib_dir: libs
    nature:
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

layout: true

.footnote[U.S. Department of Commerce | National Oceanic and Atmospheric Administration | National Marine Fisheries Service]


<style type="text/css">

code.cpp{
  font-size: 14px;
}
code.r{
  font-size: 14px;
}


</style>

```{css, echo=FALSE}
pre {
  max-height: 250px; /*changes height of chunk output box*/
  max-width: 800px; /*changes width of chunk output box*/
  overflow-y: auto; /* auto will add vertical scroll bar when necessary */
}

```
```{r set-options, include = FALSE}
options(width = 50)
```

```{r xaringan-tile-view, echo=FALSE}
# this gives you a tile navigation if you type "O" at any time
#xaringanExtra::use_tile_view()
```

---

# Outline <br>

* Reading in data for two stocks, regions and fitting models without movement
* Using `set_move`
* Using different options with example data
 * Configuring a mean movement models
 * Configuring age-specific random effects
 * Configuring year-specific random effects
 * Configuring priors

---

# Using ASAP Input <br>

When there are ASAP3 dat files for each stock/region they can be read in using the `read_asap3_dat` function.

```{r, eval = TRUE}
library(wham)
path_to_examples <- system.file("extdata", package="wham")
two_stocks_asap <- read_asap3_dat(file.path(path_to_examples,c("ex1_SNEMAYT.dat","ex1_SNEMAYT.dat")))
```

The `prepare_wham_input` function will create an input input
```{r, include = FALSE}
ini_2_stocks <- prepare_wham_input(two_stocks_asap)
```
```{r, eval = FALSE}
ini_2_stocks <- prepare_wham_input(two_stocks_asap)
```
The default input 
* assumes no connectivity of any of the data with a different region for each ASAP
* a basic statistical catch-at-age model for each stock/region just as the default with one ASAP dat file

---

# Using ASAP Input <br>

The input we created should just fit the same exact model twice simultaneously.

```{r, include = FALSE}
fit_2_stocks <- readRDS("../temp/vign_5_fit_2_stocks.RDS")
```
```{r, eval = FALSE}
fit_2_stocks <- fit_wham(ini_2_stocks, do.osa = FALSE, do.retro= FALSE, do.sdrep = FALSE)
```
```{r, eval = TRUE}
fit_2_stocks$rep$SSB
```
---

# Different stocks

We have a couple of ASAP3 .dat files included with the repo for this workshop, but adjusting the selectivity assumptions for simplicity. Note, this still assumes NO connectivity between the regions and stocks.
```{r, eval = TRUE, include = FALSE}
diff_stocks_asap <- read_asap3_dat(file.path("../data",c("north.dat","south.dat")))
selectivity <- list(model = rep(c("logistic", "age-specific"),c(8,4)), n_selblocks = 12,
	fix_pars = c(rep(list(NULL),8), list(2:8,3:8,3:8,2:8)),
	initial_pars = c(rep(list(c(2,0.2)),8),list(rep(c(0.5,1),c(1,7)), rep(c(0.5,1),c(2,6)),rep(c(0.5,1),c(2,6)),rep(c(0.5,1),c(1,7)))))
input <- prepare_wham_input(diff_stocks_asap, selectivity = selectivity)
```
```{r, eval =  FALSE}
diff_stocks_asap <- read_asap3_dat(file.path("../data",c("north.dat","south.dat")))
selectivity <- list(model = rep(c("logistic", "age-specific"),c(8,4)), n_selblocks = 12,
	fix_pars = c(rep(list(NULL),8), list(2:8,3:8,3:8,2:8)),
	initial_pars = c(rep(list(c(2,0.2)),8),list(rep(c(0.5,1),c(1,7)), rep(c(0.5,1),c(2,6)),rep(c(0.5,1),c(2,6)),rep(c(0.5,1),c(1,7)))))
input <- prepare_wham_input(diff_stocks_asap, selectivity = selectivity)
```
---

# Without ASAP Input

Using the same data that came in the ASAP3 dat files, but loading it in without them. This is similar to the code for the single stock, but we have a few other items to specify with multiple stocks and regions.

```{r, eval = TRUE}
years <- as.integer(input$years)
ages <- 1:input$data$n_ages
waa <- input$data$waa
mat <- input$data$mature
waa_pointer_indices <- input$data$waa_pointer_indices
waa_pointer_fleets <- input$data$waa_pointer_fleets
waa_pointer_ssb <- input$data$waa_pointer_ssb
fracyr_ssb <-  input$data$fracyr_SSB
```
---

# Without ASAP Input

Catch and index information structures are the same as with a single region:
```{r, eval = TRUE}
catch <- input$data$agg_catch
catch_cv <- cbind(sqrt(exp(input$data$agg_catch_sigma^2) - 1))
catch_Neff <- cbind(input$data$catch_Neff)
catch_paa <- input$data$catch_paa
use_catch_paa <- input$data$use_catch_paa
selblock_pointer_fleets <- input$data$selblock_pointer_fleets

index <- input$data$agg_indices
index_cv <- cbind(sqrt(exp(input$data$agg_index_sigma^2) - 1))
index_Neff <- cbind(input$data$index_Neff)
index_fracyr <- input$data$fracyr_indices
units_indices <- input$data$units_indices
units_index_paa <- input$data$units_index_paa
use_indices <- input$data$use_indices
use_index_paa <- input$data$use_index_paa
index_paa <- input$data$index_paa
selblock_pointer_indices <- input$data$selblock_pointer_indices
```

---


# Without ASAP Input

We need to specify a couple of more items in basic_info: region and stock names, the number of regions, region for spawning of each stock
```{r, eval = TRUE}
basic_info <- list(
	n_stocks = 2L,
	n_regions = 2L,
	region_names <- c("North_r", "South_r"),
	stock_names <- c("North_s", "South_s"),
	ages = 1:input$data$n_ages,
	n_seasons = 1L,
	n_fleets = input$data$n_fleets,
	fracyr_SSB = fracyr_ssb,
	maturity = mat,
	years = as.integer(input$years),
	waa = waa,
	waa_pointer_ssb = waa_pointer_ssb,
	spawn_regions = 1:2,
	spawn_seasons = c(1,1)
)

```

---

# Without ASAP Input

For the catch information, we also need to specify the region where each fleet operates (2 fleets in each region).
```{r, eval = TRUE}
catch_info <- list(
	n_fleets = NCOL(catch),
	agg_catch = catch,
	agg_catch_cv = catch_cv,
	catch_paa = catch_paa,
	use_catch_paa = use_catch_paa,
	catch_Neff = catch_Neff,
	selblock_pointer_fleets = selblock_pointer_fleets,
	waa_pointer_fleets = waa_pointer_fleets,
	fleet_regions = rep(c(1:2),c(2,2))
)

```
---

# Without ASAP Input

Similarly, we need to specify where the index observations come from (2 indices in each region)
```{r, eval = TRUE}
index_info <- list(
	n_indices = NCOL(index),
	agg_indices = index,
	units_indices = units_indices,
	units_index_paa = units_index_paa,
	agg_index_cv = index_cv,
	fracyr_indices = index_fracyr,
	use_indices = use_indices,
	use_index_paa = use_index_paa,
	index_paa = index_paa,
	index_Neff = index_Neff,
	selblock_pointer_indices = selblock_pointer_indices,
	waa_pointer_indices = waa_pointer_indices,
	index_regions = rep(c(1:2),c(2,2))
)
```

---

# Without ASAP Input

We will use the same selectivity assumptions defined above. Here we define the fixed natural mortality for each stock, initial $F$, and catchability:
```{r, eval = FALSE}
MAA <- exp(input$par$M_re)
for(i in 1:2) for(j in 1:2) MAA[i,j,,] <- MAA[i,j,,]*exp(matrix(input$par$Mpars[i,j,], length(basic_info$years), length(basic_info$ages), byrow = TRUE))
M_in <- list(initial_MAA = MAA)
F_in <- list(F = matrix(0.3, length(basic_info$years), catch_info$n_fleets))
q_in <- list(initial_q = rep(1e-6, index_info$n_indices))
```

Some other specifications:
* random effects on recruitment and "survival"
* Equilibrium age composition for January 1 NAA in the first year. (In multi-region models with movement, it seems typically necessary to make a simplifying assumption on how to model the initial numbers at age).

```{r, eval = FALSE}
NAA_list <- list(sigma = "rec+1", N1_model = rep("equilibrium",2))
```

---
# Multi-stock inputs: 3 ways

All at once:
```{r, eval = FALSE}
input_all <- prepare_wham_input(
	basic_info = basic_info,
	NAA_re = NAA_list,
	selectivity = selectivity, 
	catch_info = catch_info, 
	index_info = index_info, 
	M = M_in, 
	F = F_in, 
	catchability = q_in)
```
---

# Multi-stock inputs: 3 ways

Build input sequentially
```{r, eval = FALSE}
input_seq <- prepare_wham_input(basic_info = basic_info)
input_seq <- set_NAA(input_seq, NAA_re = NAA_list)
input_seq <- set_M(input_seq, M = M_in)
input_seq <- set_catch(input_seq, catch_info = catch_info)
input_seq <- set_F(input_seq, F_in)
input_seq <- set_indices(input_seq, index_info = index_info)
input_seq <- set_q(input_seq, q_in)
input_seq <- set_selectivity(input_seq, selectivity = selectivity)
```
AND using asap input
```{r, eval = FALSE}
input_asap <- prepare_wham_input(diff_stocks_asap, selectivity = selectivity, NAA_re = NAA_list)
```
---

# Compare fitted models

And you can verify that the optimized models using each of the 3 inputs gives the same results.
```{r, include = FALSE}
res_dir <- file.path("../temp")
fit_seq <- readRDS(file.path(res_dir,"vign_5_fit_2_stocks_seq.RDS"))
fit_all <- readRDS(file.path(res_dir,"vign_5_fit_2_stocks_all.RDS"))
fit_asap <- readRDS(file.path(res_dir,"vign_5_fit_2_stocks_asap.RDS"))
```
```{r, eval = FALSE}
fit_seq <- fit_wham(input_seq, do.retro = FALSE, do.osa = FALSE, do.sdrep = FALSE, do.brps = FALSE)
fit_all <- fit_wham(input_all, do.retro = FALSE, do.osa = FALSE, do.sdrep = FALSE, do.brps = FALSE)
fit_asap <- fit_wham(input_asap, do.retro = FALSE, do.osa = FALSE, do.sdrep = FALSE, do.brps = FALSE)
fit_seq$opt$obj - fit_all$opt$obj # equal
fit_asap$opt$obj - fit_all$opt$obj # equal
```
```{r, eval = TRUE}
fit_seq$opt$obj - fit_all$opt$obj # equal
fit_asap$opt$obj - fit_all$opt$obj # equal
```
---

# Movement options

The `move` argument to `prepare_wham_input` or `set_move` has these elements to configure selectivity.

* `stock_move`: T/F whether each stock can move
* `separable`: T/F whether movement for each stock should be modeled separably from mortality or both occuring simultaneously
* `mean_model`: character matrix (n_regions x n_regions - 1) for fixed effects options (mean and possibly variance) for each movement parameter are
 * `none`: (default) no movement between regions
 * `constant`: single movement rate to each region shared across all stocks, seasons, ages, years
 * `season`: season-specific movement rates to each region shared across all stocks, ages, years
 * `stock_constant`: stock-specfic movement rate to each region shared across all seasons, ages, years
 * `stock_season`: stock- and season-specfic movement rate to each region shared across all ages, years

---

# Movement options

The `move` argument to `prepare_wham_input` or `set_move` has these elements to configure selectivity.

* `age_re`: character matrix (n_regions x (n_regions-1)) for age random effects options (for each mean parameter defined in move$mean_model)
 * `none`: (default) no movement rate random effects by age
 * `iid`: independent movement rate random effects by age
 * `ar1`: first order autoregressive correlation of movement rate random effects by age.
* `year_re`: character matrix (n_regions x (n_regions-1)) for year random effects options (for each mean parameter defined in move$mean_model)
 * `none`: (default) no movement rate random effects by year
 * `iid`: independent movement rate random effects by year
 * `ar1`: first order autoregressive correlation of movement rate random effects by year.

---

# Movement options

The `move` argument to `prepare_wham_input` or `set_move` has these elements to configure selectivity.

* `prior_sigma`: array (n_stocks x n_seasons x n_regions x n_regions - 1) of sd parameters for normal priors on mean movement parameters on transformed scale (-Inf,Inf)
* `use_prior`: array (n_stocks x n_seasons x n_regions x n_regions - 1) 0/1 indicator whether to include prior for mean movement parameters in joint log-likelihood.
* `can_move`: array (n_stocks x n_seasons x n_regions x n_regions) 0/1 indicator whether movement can occur from one region to another.
* `must_move`: array (n_stocks x n_seasons x n_regions) 0/1 indicator whether movement from region must occur.
* `mean_vals`: array (n_stocks x n_seasons x n_regions x n_regions-1) of initial movement rate parameters *from* each region. Usage depends on move$mean_model.
* `sigma_vals`: array (n_stocks x n_seasons x n_regions x n_regions -1) of initial standard deviations to use for random effects. Usage depends on move$age_re and move$year_re.
* `cor_vals`: array (n_stocks x n_seasons x n_regions x n_regions - 1x 2) of initial correlation values to use for random effects. Usage depends on move$age_re and move$year_re. cor_vals[,,,,1] is for correlation with age, and cor_vals[,,,,2] is for correlation with year.

---

# Example with setting up movement

We will use the same "north" and "south" stocks as above.
* assume 5 different equal seasonal intervals within the year
* spawning occurs in the middle (season 3)
* Only the north stock can move and only to the south during seasons 1,4,5.
* All fish move back to the north at the end of season 2.

---

# Modify basic_info

Specify the intervals and redefine the time elapsed within the third interval for SSB
```{r, eval = FALSE}
basic_info$n_seasons <- 5L
basic_info$fracyr_seasons <- rep(1/5,5)
basic_info$spawn_seasons <- c(3,3)
basic_info$fracyr_SSB <- fracyr_ssb-2/5 # this should be fixed in prepare_wham_input
```

We also need to define where each stock can occur on January 1. NAA_where is a n_stocks x n_regions x n_ages array of 1s and 0s telling where each age of each stock can be on January 1.
```{r, eval = FALSE}
n_ages <- length(basic_info$ages)
#each age other than 1 (recruitment) for north stock can be in either region on Jan 1 
basic_info$NAA_where <- array(1, dim = c(2,2,n_ages))
basic_info$NAA_where[1,2,1] <- 0 #stock 1, age 1 can't be in region 2 on Jan 1
basic_info$NAA_where[2,1,] <- 0 #stock 2, any age can't be in region 1 2 on Jan 1 (stock 2 doesn't move) 
```

---

# Defining movement assumptions

```{r, eval = FALSE}
move = list(stock_move = c(TRUE,FALSE), separable = TRUE) #north moves, south doesn't
move$must_move <- array(0,dim = c(2,n_seasons,2))	
#if north stock in region 2 (south) must move back to region 1 (north) at the end of interval 2 before spawning
move$must_move[1,2,2] <- 1 #stock 1 must move at the end of season 2 from region 2
move$can_move <- array(0, dim = c(2,n_seasons,2,2))
move$can_move[1,c(1,4:5),1,2] <- 1 #only north stock can move in seasons after spawning
move$can_move[1,2,2,] <- 1 #north stock can (and must) move in last season prior to spawning back to north 
mus <- array(0, dim = c(2,n_seasons,2,1))
mus[1,1:n_seasons,1,1] <- 0.3 #initial value proportion moving to south = 0.3 (mean of prior)
mus[1,1:n_seasons,2,1] <- 0.3 #initial value proportion north to south = 0.3 (not intended to be used)
move$mean_vals <- mus 
move$mean_model <- matrix("stock_constant", 2,1) #different constant rates for each stock. (none estimated for southern stock)
```
---

# Examine unfit model

```{r, eval = FALSE}
input_move <- prepare_wham_input(
	basic_info = basic_info,
	NAA_re = NAA_list,
	selectivity = selectivity, 
	catch_info = catch_info, 
	index_info = index_info, 
	M = M_in, 
	F = F_in, 
	catchability = q_in,
	move = move)

nofit_move <- fit_wham(input_move, do.fit = FALSE, do.brps = FALSE)
```
```{r, include = FALSE}
nofit_move <- readRDS(file.path(res_dir,"vign_5_nofit_move.RDS"))
nofit_move_age <- readRDS(file.path(res_dir,"vign_5_nofit_move_age.RDS"))
nofit_move_year <- readRDS(file.path(res_dir,"vign_5_nofit_move_year.RDS"))
```

---

# Examine unfit model

Look at movement for northern stock at  age 8 each season
```{r, eval = TRUE}
#first season
nofit_move$rep$seasonal_Ps_terminal[1,1,8,,]
```
---

# Examine unfit model

```{r, eval = TRUE}
#second season
nofit_move$rep$seasonal_Ps_terminal[1,2,8,,]
```
---

# Examine unfit model

```{r, eval = TRUE}
#3rd season
nofit_move$rep$seasonal_Ps_terminal[1,3,8,,]
```
---

# Examine unfit model

```{r, eval = TRUE}
#4th season
nofit_move$rep$seasonal_Ps_terminal[1,4,8,,]
```
---

# Examine unfit model

```{r, eval = TRUE}
#5th season
nofit_move$rep$seasonal_Ps_terminal[1,5,8,,]
```

---

# Fit the model

Movement configuration in WHAM remains a bit rough. Turns out we need to manually turn off estimation of the south to north movement for stock 1, currently...
```{r, eval = FALSE}
x <- input_move$par$trans_mu
x[] <- as.integer(input_move$map$trans_mu)
x[1,,2,1] <- NA
input_move$map$trans_mu <- factor(x)

fit_move <- fit_wham(input_move, do.osa = FALSE, do.retro = FALSE, do.sdrep = FALSE, do.brps = FALSE)
```
```{r, include = FALSE}
fit_move <- readRDS("../temp/vign_5_fit_2_stocks_move.RDS")
fit_move_age <- readRDS("../temp/vign_5_fit_2_stocks_move_age.RDS")
fit_move_year <- readRDS("../temp/vign_5_fit_2_stocks_move_year.RDS")
fit_move_prior <- readRDS("../temp/vign_5_fit_2_stocks_move_prior.RDS")
```
About 5% movement each season
```{r, eval = TRUE}
fit_move$rep$mu[1,8,1,1,1,2]
```
---

# Age-specific random effects

```{r, eval = FALSE}
move_age <- move
move_age$age_re <- matrix("none",2,1)
move_age$age_re[1,1] <- "iid"

input_move_age <- prepare_wham_input(
	basic_info = basic_info,
	NAA_re = NAA_list,
	selectivity = selectivity, 
	catch_info = catch_info, 
	index_info = index_info, 
	M = M_in, 
	F = F_in, 
	catchability = q_in,
	move = move_age)

nofit_move_age <- fit_wham(input_move_age, do.fit = FALSE, do.brps = FALSE)
nofit_move_age$rep$mu[1,1:8,1,1,1,2]
```
Age-specific movement rates assuming initial values for fixed effects
```{r, eval = TRUE, echo = FALSE}
nofit_move_age$rep$mu[1,1:8,1,1,1,2]
```
---

# Age-specific random effects

```{r, eval = FALSE}
x <- input_move_age$par$trans_mu
x[] <- as.integer(input_move_age$map$trans_mu)
x[1,,2,1] <- NA
input_move_age$map$trans_mu <- factor(x)
input_move_age$par <- fit_move$parList
fit_move_age <- fit_wham(input_move_age, do.osa = FALSE, do.retro = FALSE, do.sdrep = FALSE, do.brps = FALSE)
```
```{r}
fit_move$opt$obj
fit_move_age$opt$obj
#same

#the log(sd) of the RE
fit_move_age$parList$mu_repars[1,1,1,1,1]
```

---

# Year-specific random effects

```{r, eval = FALSE}
move_year <- move
move_year$year_re <- matrix("none",2,1)
move_year$year_re[1,1] <- "iid"

input_move_year <- prepare_wham_input(
	basic_info = basic_info,
	NAA_re = NAA_list,
	selectivity = selectivity, 
	catch_info = catch_info, 
	index_info = index_info, 
	M = M_in, 
	F = F_in, 
	catchability = q_in,
	move = move_year)

nofit_move_year <- fit_wham(input_move_year, do.fit = FALSE, do.brps = FALSE)
#year-specific movement rates assuming initial values for fixed effects
nofit_move_year$rep$mu[1,8,1,,1,2]
```
Year-specific movement rates assuming initial values for fixed effects
```{r, eval = TRUE, echo = FALSE}
nofit_move_year$rep$mu[1,8,1,,1,2]
```

---

# Year-specific random effects

```{r, eval = FALSE}
x <- input_move_year$par$trans_mu
x[] <- as.integer(input_move_year$map$trans_mu)
x[1,,2,1] <- NA
input_move_year$map$trans_mu <- factor(x)
input_move_year$par <- fit_move$parList
fit_move_year <- fit_wham(input_move_year, do.osa = FALSE, do.retro = FALSE, do.sdrep = FALSE, do.brps = FALSE)
```
```{r}
fit_move$opt$obj
fit_move_year$opt$obj
#not the same

#the log(sd) of the RE
fit_move_year$parList$mu_repars[1,1,1,1,1]
```

---

# Year-specific random effects
```{r}
plot(fit_move_year$years,fit_move_year$rep$mu[1,8,1,,1,2], ylab = "Move North to South", xlab = "Year")
```

---

# Configure a prior distribution for mean movement

```{r, eval = FALSE}
move_prior <- move
move_prior$use_prior <- array(0, dim = c(2,n_seasons,2,1))
#movement is not used in first season, but the parameter is constant across seasons. Could use it in any (single) season
move_prior$use_prior[1,1,1,1] <- 1
# sd on logit scale
move_prior$prior_sigma <- array(0, dim = c(2,n_seasons,2,1))
move_prior$prior_sigma[1,1,1,1] <- 0.2

input_move_prior <- prepare_wham_input(
	basic_info = basic_info,
	NAA_re = NAA_list,
	selectivity = selectivity, 
	catch_info = catch_info, 
	index_info = index_info, 
	M = M_in, 
	F = F_in, 
	catchability = q_in,
	move = move_prior)
```

---

# Configure a prior distribution for mean movement

Don't estimate south to north movement
```{r, eval = FALSE}
x <- input_move_prior$par$trans_mu
x[] <- as.integer(input_move_prior$map$trans_mu)
x[1,,2,1] <- NA
input_move_prior$map$trans_mu <- factor(x)
```

For efficiency, start at MLEs except the mean movement rate parameter
```{r, eval = FALSE}
#fixed effect estimated in fit_move
ind <- names(fit_move$parList)[!names(fit_move$parList) %in% "trans_mu"]
input_move_prior$par[ind] <- fit_move$parList[ind]

fit_move_prior <- fit_wham(input_move_prior, do.osa = FALSE, do.retro = FALSE, do.sdrep = FALSE, do.brps = FALSE)
```
Estimate with prior is higher because it is being pulled toward the mean of the prior.
```{r, eval = TRUE}
#estimated movement
fit_move$rep$mu[1,8,1,1,1,2]
fit_move_prior$rep$mu[1,8,1,1,1,2]
```

---

# Northern stock by region

.pull-left[
Constant movement
```{r, echo = FALSE, out.width="100%", fig.align="center"}
prop_AA <- t(sapply(1:33, function(y) sapply(2:8, function(x) fit_move$rep$NAA[1,2,y,x]/sum(fit_move$rep$NAA[1,,y,x]))))
matplot(fit_move$years, prop_AA, type = 'l', ylab = "Proportion of northern stock in the south", xlab = "Year", lty = 1, col = 1:7)
legend("topright", legend = paste0("Age ", 2:8), col = 1:7, lty  = 1)
```
]
.pull-right[
Year-specific movement
```{r, echo = FALSE, out.width="100%", fig.align="center"}
prop_AA <- t(sapply(1:33, function(y) sapply(2:8, function(x) fit_move_year$rep$NAA[1,2,y,x]/sum(fit_move_year$rep$NAA[1,,y,x]))))
matplot(fit_move$years, prop_AA, type = 'l', ylab = "Proportion of northern stock in the south", xlab = "Year", lty = 1, col = 1:7)
legend("topright", legend = paste0("Age ", 2:8), col = 1:7, lty  = 1)
```
]